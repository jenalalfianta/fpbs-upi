---
import Layout from '../../../layouts/Layout.astro';
import ProgramStudiMenu from '../../../components/prodi/ProgramStudiMenu.astro';
import ProgramStudiContent from '../../../components/prodi/ProgramStudiContent.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

const { slug, tab } = Astro.params;

const prodiData = await getEntryBySlug('program-studi', `id/${slug}`);
if (!prodiData) throw new Error(`Data tidak ditemukan untuk slug: ${slug}`);

const activeTab = tab || 'profil';
const menuItems = prodiData.data.menu || [];
const tabLabel = menuItems.find(item => item.id === activeTab)?.label || activeTab;
const baseProdiPath = `/program-studi/${slug}`;
const dynamicHeading = tabLabel;
const dynamicSubtitle = prodiData.data.title;
const breadcrumbItems = [
  { label: 'Beranda', href: '/index.html' },
  { label: 'Program Studi', href: '/profil/program-studi/index.html' },
  { label: prodiData.data.title, href: `${baseProdiPath}/profil/index.html` },
  { label: tabLabel },
];

export async function getStaticPaths() {
  const entries = (await getCollection('program-studi')).filter(e => e.id.startsWith('id/'));
  const paths = [];

  for (const entry of entries) {
    const slug = entry.slug.split('/')[1]; // ambil bagian setelah 'id/'
    const tabs = entry.data.menu?.map(item => item.id) || ['profil'];

    for (const tab of tabs) {
      paths.push({ params: { slug, tab } });
    }
  }

  return paths;
}
---

<Layout
  pageHeading={dynamicHeading}
  pageSubtitle={dynamicSubtitle}
  breadcrumbItems={breadcrumbItems}
  pageHeadingOverlay="linear-gradient(90deg, rgba(31,15,61,0.85) 0%, rgba(49,26,92,0.70) 55%, rgba(31,15,61,0.45) 100%)"
  pageHeadingAlign="left"
  breadcrumbBackground="bg-[#f6f8ff] dark:bg-[#0b132a]"
>
  <div class="bg-[#f6f8ff] dark:bg-[#0b132a]">
    <div class="py-4 px-4 md:px-6">
      <ProgramStudiMenu activeTab={activeTab} menuItems={menuItems} slug={slug} prodiId={prodiData.id} />
    </div>
    <div class="px-4 md:px-6 pb-6">
      <ProgramStudiContent activeTab={activeTab} prodiData={prodiData} />
    </div>
  </div>
</Layout>

<!-- Script eksternal jika dibutuhkan -->
<script src="https://cdn.jsdelivr.net/npm/apextree" defer></script>
<link rel="stylesheet" href="/vendor/photoswipe/photoswipe.css" />
<script is:inline type="module">
  import PhotoSwipeLightbox from '/vendor/photoswipe/photoswipe-lightbox.esm.js';
  import PhotoSwipe from '/vendor/photoswipe/photoswipe.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '.dosen-gallery',
    children: 'a.zoomable',
    pswpModule: () => Promise.resolve(PhotoSwipe)
  });
  lightbox.init();
</script>
