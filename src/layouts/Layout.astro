---
import "../styles/global.css";
import { getPageTitle } from "../scripts/title.ts";
import Breadcrumb from "@/components/Breadcrumb.astro";
import PageHeader from "@/components/PageHeader.astro";

const {
  pageTitle,
  pageDescription,
  breadcrumbItems,
  showBreadcrumb = true,
  pageHeading,
  pageSubtitle,
  pageHeadingOverlay,
  pageHeadingAlign = 'left',
  headingAfterSubheader = false,
} = Astro.props;

const pathname = Astro.url.pathname;
const lang = pathname.startsWith('/en') ? 'en' : 'id';
const baseSiteTitle = 'Fakultas Pendidikan Bahasa dan Sastra';
const fallbackTitle = getPageTitle(pathname);
const primaryTitle = pageHeading ?? pageTitle ?? fallbackTitle;
const title = primaryTitle ? `${baseSiteTitle} - ${primaryTitle}` : baseSiteTitle;
const description = pageDescription ?? "Website resmi Fakultas Pendidikan Bahasa dan Sastra Universitas Pendidikan Indonesia (FPBS UPI).";

const Navbar = lang === 'en'
  ? (await import("../components/NavbarEn.astro")).default
  : (await import("../components/Navbar.astro")).default;

const Footer = lang === 'en'
  ? (await import("../components/FooterEn.astro")).default
  : (await import("../components/Footer.astro")).default;

const baseHome = lang === 'en' ? '/en/index.html' : '/index.html';
const labels = {
  home: { id: 'Beranda', en: 'Home' },
  profile: { id: 'Profil', en: 'Profile' },
  news: { id: 'Berita', en: 'News' },
  studyPrograms: { id: 'Program Studi', en: 'Study Programs' },
};

function toTitleCase(str: string) {
  return str.replace(/[-_]/g, ' ')
    .split(' ')
    .filter(Boolean)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
}

function buildAutoBreadcrumb(pathname: string) {
  const clean = pathname.replace(/\/index\.html$/, '').replace(/^\/+/, '');
  let segments = clean ? clean.split('/') : [];
  const prefix = lang === 'en' ? '/en' : '';

  if (lang === 'en' && segments[0] === 'en') {
    segments = segments.slice(1);
  }

  if (segments.length === 0) return [];

  const items = [{ label: labels.home[lang], href: baseHome }];

  segments.forEach((seg, idx) => {
    const isLast = idx === segments.length - 1;
    const mapLabel =
      (seg === 'profil' || seg === 'profile') ? labels.profile[lang] :
      (seg === 'berita' || seg === 'news') ? labels.news[lang] :
      (seg === 'program-studi' || seg === 'study-programs') ? labels.studyPrograms[lang] :
      null;

    const label = mapLabel ?? toTitleCase(seg);
    // Jangan bikin link kalau hanya 1 segmen (mis. /profil) karena tidak ada halaman indeks
    // Hindari link untuk segmen yang tidak punya landing (mis. /profil)
    const hasLanding = !(seg === 'profil' || seg === 'profile');
    const href = (segments.length === 1 || isLast || !hasLanding)
      ? undefined
      : `${prefix}/${segments.slice(0, idx + 1).join('/')}/index.html`;
    items.push({ label, href });
  });

  return items;
}

const isHome =
  pathname === '/' ||
  pathname === '/index.html' ||
  pathname === '/en' ||
  pathname === '/en/' ||
  pathname === '/en/index.html';

const computedBreadcrumb = breadcrumbItems ?? (isHome ? [] : buildAutoBreadcrumb(pathname));
const resolvedHeading = isHome ? undefined : (pageHeading ?? title);
const resolvedSubtitle = isHome ? undefined : pageSubtitle;
const shouldShowBreadcrumb = showBreadcrumb && !isHome && computedBreadcrumb?.length > 1;
const shouldShowHeader = !isHome && (shouldShowBreadcrumb || !!resolvedHeading);
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon-16x16.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content="FPBS UPI, berita FPBS, sastra, bahasa, universitas pendidikan indonesia" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E09XPHZJTL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E09XPHZJTL');
    </script>
  </head>

  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
    <Navbar />
    <slot name="subheader" />
    {shouldShowHeader ? (
      <PageHeader
        heading={resolvedHeading}
        subtitle={resolvedSubtitle}
        uppercase={true}
        items={headingAfterSubheader ? [] : (shouldShowBreadcrumb ? computedBreadcrumb : [])}
        className="mt-0"
        overlayColor={pageHeadingOverlay}
        align={pageHeadingAlign}
        showText={!headingAfterSubheader}
      />
    ) : null}

    {!headingAfterSubheader && shouldShowBreadcrumb ? (
      <div class="max-w-6xl mx-auto px-4 py-4">
        <Breadcrumb items={computedBreadcrumb} className="px-0 py-0" />
      </div>
    ) : null}

    {headingAfterSubheader && resolvedHeading ? (
      <div class="max-w-6xl mx-auto px-4 py-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-2 uppercase">
          {resolvedHeading}
        </h1>
        {shouldShowBreadcrumb ? <Breadcrumb items={computedBreadcrumb} className="px-0 py-0" /> : null}
      </div>
    ) : null}

    <main>
      <slot />
    </main>
    <Footer />

    <script defer src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/theme-toggle.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sienna-accessibility@latest/dist/sienna-accessibility.umd.js" defer></script>

    <button id="backToTop" title="Kembali ke Atas" class="fixed z-[9999] bottom-4 right-4 bg-purple-700 hover:bg-purple-800 text-white rounded-full p-3 shadow-lg hidden transition-opacity duration-300">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 384 512">
        <path d="M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 141.2V448c0 17.7 14.3 32 32 32s32-14.3 32-32V141.2L329.4 246.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-160-160z"/>
      </svg>
    </button>
    <script>
      const btn = document.getElementById('backToTop');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          btn.classList.remove('hidden');
          btn.classList.add('opacity-100');
        } else {
          btn.classList.add('hidden');
        }
      });
      btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>
  </body>
</html>

<style>
  html, body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
